name: Build hello_idax Plugin

on:
  push:
    branches: [ main, master ]
  pull_request:
    branches: [ main, master ]

jobs:
  build:
    runs-on: ${{ matrix.os }}
    
    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-latest
            c_compiler: cl
            cpp_compiler: cl
            build_type: Release
            artifact_name: hello_idax-windows-msvc
            cxx_flags: "/std:c++latest"
            
          - os: ubuntu-latest
            c_compiler: gcc
            cpp_compiler: g++
            build_type: Release
            artifact_name: hello_idax-linux-gcc
            cxx_flags: "-std=c++23"
            
          - os: ubuntu-latest
            c_compiler: clang-18
            cpp_compiler: clang++-18
            build_type: Release
            artifact_name: hello_idax-linux-clang
            cxx_flags: "-std=c++2b"

    steps:
    - name: Checkout hello_idax
      uses: actions/checkout@v4

    - name: Checkout IDA SDK
      uses: actions/checkout@v4
      with:
        repository: HexRaysSA/ida-sdk
        path: idasdk

    - name: Install ida-cmake
      shell: bash
      run: |
        # Clone ida-cmake into the IDA SDK directory
        git clone --depth 1 https://github.com/allthingsida/ida-cmake.git idasdk/ida-cmake
        
        # Verify installation
        if [ ! -f "idasdk/ida-cmake/bootstrap.cmake" ]; then
          echo "::error::ida-cmake bootstrap.cmake not found!"
          exit 1
        fi
        
        echo "ida-cmake installed successfully"
        ls -la idasdk/ida-cmake/

    - name: Setup Environment
      shell: bash
      run: |
        # Set IDASDK environment variable (cmake.toml handles path resolution)
        echo "IDASDK=${{ github.workspace }}/idasdk" >> $GITHUB_ENV
        
        # Create output directory for plugins (required by cmake.toml)
        mkdir -p ${{ github.workspace }}/build/output/plugins
        echo "IDABIN=${{ github.workspace }}/build/output" >> $GITHUB_ENV
        
    - name: Install Clang 18
      if: matrix.c_compiler == 'clang-18'
      run: |
        sudo apt-get update
        sudo apt-get install -y clang-18 libc++-18-dev libc++abi-18-dev
    
    - name: Configure CMake (cmkr bootstrap)
      shell: bash
      run: |
        # Step 1: Generate CMakeLists.txt from cmake.toml using cmkr
        env -u CI cmake -P cmkr.cmake
      
        # Step 2: Now configure with CMake
        cmake -B build \
          -DCMAKE_CXX_COMPILER=${{ matrix.cpp_compiler }} \
          -DCMAKE_C_COMPILER=${{ matrix.c_compiler }} \
          -DCMAKE_BUILD_TYPE=${{ matrix.build_type }} \
          -DCMAKE_CXX_STANDARD=23 \
          -DCMAKE_CXX_STANDARD_REQUIRED=ON \
          -DCMAKE_CXX_FLAGS="${{ matrix.cxx_flags }}" \
          -S .
      env:
        IDASDK: ${{ github.workspace }}/idasdk
        IDABIN: ${{ github.workspace }}/build/output

    - name: Build Plugin
      run: cmake --build build --config ${{ matrix.build_type }}
      env:
        IDASDK: ${{ github.workspace }}/idasdk
        IDABIN: ${{ github.workspace }}/build/output

    - name: Verify Build Outputs
      shell: bash
      run: |
        echo "Looking for built plugin..."
        find build -name "hello*" -type f 2>/dev/null || true
        find build -name "*.dll" -o -name "*.so" -o -name "*.dylib" | head -20

    # Rename artifacts with platform/compiler info for clarity
    - name: Prepare Artifacts
      shell: bash
      run: |
        mkdir -p artifacts
        if [ "${{ matrix.os }}" = "windows-latest" ]; then
          find build -name "*.dll" -exec cp {} "artifacts/${{ matrix.artifact_name }}.dll" \;
        else
          find build -name "*.so" -exec cp {} "artifacts/${{ matrix.artifact_name }}.so" \;
        fi
        ls -la artifacts/

    - name: Upload Build Artifact
      uses: actions/upload-artifact@v4
      with:
        name: ${{ matrix.artifact_name }}
        path: artifacts/*
        if-no-files-found: error
