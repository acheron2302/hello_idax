# cmkr configuration for hello_idax - Minimal IDA Pro Plugin Template using idax
# 
# Build Instructions:
#   1. Set IDASDK environment variable to your IDA SDK root
#   2. Generate build files: cmake -B build
#   3. Build the plugin: cmake --build build

[cmake]
version = "3.27"
cmkr-include = "cmkr.cmake"

[project]
name = "hello_idax"
version = "1.0.0"
description = "Minimal IDA Pro plugin template using idax"
languages = ["CXX"]
# Use dynamic runtime
msvc-runtime = "dynamic"
# Set up IDASDK path BEFORE project() - environment setup only
cmake-before = """
# Verify IDASDK environment variable
if(NOT DEFINED ENV{IDASDK})
    message(FATAL_ERROR "IDASDK environment variable is not set!")
endif()

set(IDASDK_PATH "$ENV{IDASDK}")
file(TO_CMAKE_PATH "${IDASDK_PATH}" IDASDK_CMAKE_PATH)
message(STATUS "Original IDASDK: ${IDASDK_CMAKE_PATH}")

# Handle GitHub SDK structure (ida-cmake might be at parent level, SDK in src/)
if(NOT EXISTS "${IDASDK_CMAKE_PATH}/ida-cmake/bootstrap.cmake")
    get_filename_component(IDASDK_PARENT "${IDASDK_CMAKE_PATH}" DIRECTORY)
    message(STATUS "Looking for ida-cmake in parent: ${IDASDK_PARENT}")
    if(EXISTS "${IDASDK_PARENT}/ida-cmake/bootstrap.cmake")
        set(IDASDK_CMAKE_PATH "${IDASDK_PARENT}")
        message(STATUS "Found ida-cmake in parent, using: ${IDASDK_CMAKE_PATH}")
    endif()
endif()

if(NOT EXISTS "${IDASDK_CMAKE_PATH}/ida-cmake/bootstrap.cmake")
    message(FATAL_ERROR "ida-cmake not found at IDASDK='${IDASDK_PATH}' or '${IDASDK_CMAKE_PATH}'")
endif()

# For GitHub SDK structure, the actual SDK is in src/
if(EXISTS "${IDASDK_CMAKE_PATH}/src/include/pro.h")
    set(IDASDK_ACTUAL_PATH "${IDASDK_CMAKE_PATH}/src")
    message(STATUS "Detected GitHub SDK structure, using src/ subdirectory")
else()
    set(IDASDK_ACTUAL_PATH "${IDASDK_CMAKE_PATH}")
endif()

# Update the environment variable for ida-cmake
set(ENV{IDASDK} "${IDASDK_ACTUAL_PATH}")
message(STATUS "Set ENV{IDASDK} to: $ENV{IDASDK}")

# Set idasdk_DIR for find_package
set(idasdk_DIR "${IDASDK_CMAKE_PATH}/ida-cmake")
message(STATUS "Set idasdk_DIR to: ${idasdk_DIR}")
"""

# NOW safe to call find_package after project() sets CMAKE_SYSTEM_NAME
cmake-after = """
# Include idasdk (platform is now detected properly)
find_package(idasdk REQUIRED)
"""

[fetch-content.idax]
git = "https://github.com/19h/idax.git"
subdir = "AVOID_calling_ADD_SUBDIR_in_subseqeuent_MAKEAVILABLE"

# Plugin target - standard CMake shared library
[target.hello]
cmake-before = """
# Manually create the idax target (bypassing its CMakeLists.txt)
file(GLOB_RECURSE IDAX_SOURCES CONFIGURE_DEPENDS "${idax_SOURCE_DIR}/src/*.cpp")
add_library(idax STATIC ${IDAX_SOURCES})
add_library(idax::idax ALIAS idax)

target_include_directories(idax
    PUBLIC
        ${idax_SOURCE_DIR}/include
    PRIVATE
        ${idax_SOURCE_DIR}/src
)

# Link idax against idasdk
target_link_libraries(idax PUBLIC idasdk::plugin)
target_compile_features(idax PUBLIC cxx_std_23)
"""

type = "shared"
sources = ["src/**.cpp"]
compile-features = ["cxx_std_23"]
link-libraries = ["idasdk::plugin", "idax"]
# Windows: SUBSYSTEM:WINDOWS
windows.link-options = ["/SUBSYSTEM:WINDOWS"]

[target.hello.properties]
CXX_STANDARD_REQUIRED = true
RUNTIME_OUTPUT_DIRECTORY = "${IDABIN}/plugins"
LIBRARY_OUTPUT_DIRECTORY = "${IDABIN}/plugins"